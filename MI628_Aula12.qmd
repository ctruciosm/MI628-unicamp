---
title: "Inferência Causal"
subtitle: "Propensity score em modelos de regressão"
author: "Prof. Carlos Trucíos </br> ctrucios@unicamp.br"
Email: "ctrucios@unicamp.br"
institute: "Instituto de Matemática, Estatística e Computação Científica (IMECC), </br> Universidade Estadual de Campinas (UNICAMP)."
toc: true
toc-depth: 1
toc-title: "Conteúdo"
knitr:
    opts_chunk: 
      fig.align: 'center'
execute:
    message: false
    warning: false
format:
    revealjs:
        slide-number: true
        show-slide-number: print
        self-contained: false
        chalkboard: true
        width: 1600
        height: 900
        theme: [default, styles.scss]
        incremental: true
        code-fold: true
        logo: "imagens/imecc.png"
        footer: "Carlos Trucíos (IMECC/UNICAMP)  |  ME920/MI628 - Inferência Causal |  [ctruciosm.github.io](https://ctruciosm.github.io/)"
        highlight-style: "a11y"
        title-slide-attributes:
            data-background-image: "imagens/unicamp.png"
            data-background-size: 20%
            data-background-position: 99% 5%
            data-background-opacity: "1"
---



# Introdução
## Introdução

- Desde que [Rosenbaum e Rubin (1983)](https://academic.oup.com/biomet/article/70/1/41/240879) introduziram _propensity score_, diversos usos tem aparecido na literatura.
- Hoje discutiremos dois métodos que utilizam _propensity score_:
    *   Incluir _propensity score_ como covariável num modelo de regressão.
    *   Ajustar uma regressão ponderada com pesos dados pelo inverso do _propensity score_.
- Estas propostas são fáceis de implementar e tem propriedades semelhantes a muitas das propostas mais complexas.


# Propensity score como covariável
## Propensity score como covariável

[Anteriormente](https://ctruciosm.github.io/MI628-unicamp/MI628_Aula09#/propensity-score-redu%C3%A7%C3%A3o-de-dimens%C3%A3o-1), vimos que se ignorabilidade acontece (condicionada em $X$), também acontece condicionada em $e(X)$. Ou seja, $$Z \perp\!\!\!\perp  \{ Y(1), Y(0)\} | e(X).$$


. . . 


Ademais, \begin{align}
\tau & = \mathbb{E}[Y(1) - Y(0)], \\
     & = \mathbb{E}[Y(1)] - \mathbb{E}[Y(1)], \\
     & = \mathbb{E}[\mathbb{E} \{ Y(1)| Z = 1, e(X) \}] - \mathbb{E}[\mathbb{E} \{ Y(0)| Z = 0, e(X) \}], \\
     & = \mathbb{E}[\mathbb{E} \{ Y| Z = 1, e(X) \} - \mathbb{E} \{ Y| Z = 0, e(X) \}].
\end{align}

. . . 

<center>
[Isto motiva um método baseado na regressão de $Y$ com $Z$ e $e(X)$.]{style="color:red"}
</center>


## Propensity score como covariável

- A especificação mais simples é ajustar, por MQO, uma regressão linear múltiple de $Y$ sob $(1, Z, e(X))$.
- O estimador desejado será o coeficiente associado a $Z$ e será denotado por $\tau_e$.
- Se o modelo do _propensity score_ for correto e $Y$ for linear em $Z$ e $e(X)$, então $\tau_e$ é consistente para $\tau$.
- Ademais, $\tau_e$ estima $\tau_O$ se o modelo do _propensity score_ for correto, mesmo se $Y$ for má-especificado.


## Propensity score como covariável

::: {.callout-tip}
### Teorema
Se $Z \perp\!\!\!\perp  \{ Y(1), Y(0)\} | X$, então o coeficiente associado a $Z$ na regressão (populacional) por MQO de $Y$ sob $(1, Z, e(X))$ é igual a: 


$$\tau_e = \tau_O = \dfrac{\mathbb{E}[h_O(X)\tau(X)]}{\mathbb{E}[h_O(X)]},$$ em que $h_O(X) = e(X)(1 - e(X))$ e $\tau(X) = \mathbb{E}[Y(1) - Y(0)|X].$

:::

<center>
[**Demostração** (no quadro)]{style="color:red"}
</center>


## Propensity score como covariável

::: {.callout-tip}
### Corolário
Se $Z \perp\!\!\!\perp  \{ Y(1), Y(0)\} | X$, então:

::: {.nonincremental}
1. O coeficiente associado a $Z - e(X)$ na regressão (populacional) por MQO de $Y$ sob $(1, Z - e(X))$ é igual a $\tau_O$.
2. O coeficiente associado a $Z$ na regressão (populacional) por MQO de $Y$ sob $(1, Z, e(X), X)$ é igual a $\tau_O$.
:::

:::

<center>
[**Demostração** (no quadro)]{style="color:red"}
</center>

## Propensity score como covariável

Os resultados teóricos anunciados anteriormente, motivam os seguines estimadores:


:::: {.columns}

::: {.column width="33.3%"}
#### Estimador 1
::: {.nonincremental}
1. Ajustar um modelo de _propensity score_ e obter $\hat{e}(X_i).$
2. Ajustar, por MQO, a regressão de $Y$ sob $(1, Z, \hat{e}(X))$ e obter o coeficiente associado a $Z$.
:::
:::

::: {.column width="33.4%"}
#### Estimador 2
::: {.nonincremental}
1. Ajustar um modelo de _propensity score_ e obter $\hat{e}(X_i).$
2. Ajustar, por MQO, a regressão de $Y$ sob $(1, Z - \hat{e}(X))$ e obter o coeficiente associado a $Z - \hat{e}(X)$.
:::
:::

::: {.column width="33.3%"}
#### Estimador 3
::: {.nonincremental}
1. Ajustar um modelo de _propensity score_ e obter $\hat{e}(X_i).$
2. Ajustar, por MQO, a regressão de $Y$ sob $(1, Z, \hat{e}(X), X)$ e obter o coeficiente associado a $Z$.
:::
:::

::::

. . . 

<center>
[Embora MQO é conveniente para obtermos estimadores pontuais, os correspondentes desvios padrão são incorretos devido à incerteza no passo 1. Uma alternativa é utilizar Bootstrap.]{style="color:blue"}
</center>


# MQP
## MQP

Lembremos do estimador de Hajek para $\tau$: 

$$\hat{\tau}^{Hajek} = \dfrac{\displaystyle \sum_{i = 1}^n \dfrac{Z_iY_i}{\hat{e}(X_i)}}{\displaystyle \sum_{i = 1}^n \dfrac{Z_i}{\hat{e}(X_i)}} - \dfrac{\displaystyle \sum_{i = 1}^n \dfrac{(1 - Z_i)Y_i}{(1 - \hat{e}(X_i))}}{\displaystyle \sum_{i = 1}^n \dfrac{(1 - Z_i)}{(1 - \hat{e}(X_i))}}.$$


. . . 

<center>
[$\hat{\tau}^{Hajek}$ concide com o coeficiente associado a $Z$ da regressão por MQP de $Y$ sob $(1, Z).$]{style="color:red"}
</center>


## MQP


::: {.callout-tip}
### Proposição
$\hat{\tau}^{Hajek}$ é igual ao $\hat{\beta}$ da regressão por MQP, i.e, $$(\hat{\alpha}, \hat{\beta}) = arg\min_{\alpha, \beta} \displaystyle \sum_{i = 1}^n w_i (Y_i - \alpha - \beta Z_i)^2,$$ em que $w_i = \dfrac{Z_i}{\hat{e}(X_i)} + \dfrac{1 - Z_i}{1 - \hat{e}(X_i)} = \left\{ \begin{array}{ll}
		\dfrac{1}{\hat{e}(X_i)} & \text{se }  Z_i = 1,\\
		\dfrac{1}{1 - \hat{e}(X_i)} & \text{se }  Z_i = 0.
	\end{array}\right.$

:::

. . . 

#### Observação:

- Por simplicidade, é conveniente utilizar MQP para obter $\hat{\tau}^{Hajek}$.
- Contudo, devemos ter cuidado com o desvio padrão reportado por MQP pois este não leva em consideração a incerteza da estimação do _propensity score._ Uma forma de contornar o problema é utilizando Bootstrap para estimar o desvio padrão.


## MQP


- No CRE tinhamos visto que, para melhorar a eficiência, podiamos ajustar a regressão de $Y$ sob $(1, Z, X, Z \times X)$ (Estimador de Lin).
- Será que no contexto de estudos observacionais podemos ajustar MQP $Y$ sob $(1, Z, X, Z \times X)$?
    *   **Sim!**
    *   De fato, Hirano e Imbens (2001) utilizam esta mesma ideia.
    *   Esta proposta é interessante pois o estimador obtido por MQP será também DR
    
    
## MQP

::: {.callout-tip}
### Teorema
Se $\bar{X} = 0$ e $(\mu_1(X, \hat{\beta}_1), \mu_0(X, \hat{\beta}_0)) = (\hat{\beta}_{10} + X \hat{\beta}_{11}, \hat{\beta}_{00} + X \hat{\beta}_{01})$ baseado na regressão por MQP de $Y$ sob $(1, Z, X, Z \times X)$ com $$w_{i} = \left\{ \begin{array}{ll}
		\dfrac{1}{\hat{e}(X_i)} & \text{se }  Z_i = 1,\\
		\dfrac{1}{1 - \hat{e}(X_i)} & \text{se }  Z_i = 0.
	\end{array}\right.$$ Então $$\hat{\tau}_{MQP}^{DR} = \hat{\tau}_{MQP}^{Reg} = \hat{\beta}_{10} - \hat{\beta}_{00},$$ que é o coeficiente associado a $Z$ na regressão por MQP
:::

<center>
[**Demostração** (no quadro)]{style="color:red"}
</center>


## MQP


::: {.callout-note}
### Estimadores

|                    | CRE        | Estudos Observacionais     |
|:------------------:|:----------:|:--------------------------:|
| Sem $X$            | $Y \sim (1, Z)$ | $Y \sim (1, Z)$ com pesos $w_i$ |
| Com $X$            | $Y \sim (1, Z, X, Z \times X)$ | $Y \sim (1, Z, X, Z \times X)$ com pesos $w_i$ |

:::


<aside>
Os estudos observacionais mencionados aqui assumem que a suposição de ignorabilidade acontece, ou seja, não existe nenhuma variável de confusão que não tenha sido medida.
</aside>


# Efeito causal médio nas unidades de tratamento
## Efeito causal médio nas unidades de tratamento

O estimador de Hajek para $\tau_T$ é dado por

$$\hat{\tau}_T^{Hajek} = \hat{\bar{Y}}(1) - \dfrac{\sum_{i = 1}^n \hat{o}(X_i)(1 - Z_i) Y_i}{\sum_{i = 1}^n \hat{o}(X_i)(1 - Z_i)},$$ com $\hat{o}(X_i) = \hat{e}(X_i) /(1 - \hat{e}(X_i))$.


#### Observação:
<center>
$\hat{\tau}_T^{Hajek}$ coincide com coeficiente associado a $Z$ na regressão por MQP de $Y$ sob $(1, Z)$ com $w_{Ti} = Z_i+ (1 - Z_i)\hat{o}(X_i)= \left\{ \begin{array}{ll}
		1& \text{se }  Z_i = 1,\\
		\hat{o}(X_i) & \text{se }  Z_i = 0.
	\end{array}\right.$
</center>


## Efeito causal médio nas unidades de tratamento


De forma semelhante ao desenvolvido para $\tau$, se $\bar{X}(1) = 0$ podemos estimar $\tau_T$ como o coeficiente associado a $Z$ da regressão por MQP de $Y$ sob $(1, Z, X, Z \times X)$ com pesos $w_{Ti} = \left\{ \begin{array}{ll}
		1& \text{se }  Z_i = 1,\\
		\hat{o}(X_i) & \text{se }  Z_i = 0.
	\end{array}\right.$

Este estimador é igual ao estimador de regressão $$\hat{\tau}_{T, MQP}^{Reg} = \hat{\bar{Y}}(1) - \dfrac{1}{n_1} \sum_{i = 1}^n Z_i \mu_0(X_i, \hat{\beta}_0),$$ que por sua vez, é igual ao estimador DR

$$\hat{\tau}_{T, MQP}^{DR} = \hat{\tau}_{T, MQP}^{Reg} - \dfrac{1}{n_1}\sum_{i = 1}^n\hat{o}(X_i)(1 - Z_i)(Y_i - \mu_0(X_i, \hat{\beta}_0)).$$


## Efeito causal médio nas unidades de tratamento



::: {.callout-tip}
### Teorema
Se $\bar{X}(1) = 0$ e $\mu_0(X_i, \hat{\beta}_0) = \hat{\beta}_{00} + X_i \hat{\beta}_{01}$ baseado na regressão por MQP de $Y$ sob $(1, Z, X, Z \times X)$ com pesos $$w_{Ti} = \left\{ \begin{array}{ll}
		1& \text{se }  Z_i = 1,\\
		\hat{o}(X_i) & \text{se }  Z_i = 0.
	\end{array}\right.$$ Então,

$$\hat{\tau}_{T, MQP}^{DR} = \hat{\tau}_{T, MQP}^{Reg} = \hat{\beta}_{10} - \hat{\beta}_{00},$$ que é o coeficiente associado a $Z$ na regressão por MQP.
:::


## Referências

::: {.nonincremental}

- Peng Ding (2023). A First Course in Causal Inference. Capítulo 14.

:::